name: Preview Deploy

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ master ]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        run: |
          pnpm build
          echo "é¢„è§ˆç¯å¢ƒæ„å»ºå®Œæˆ" > docs/.vitepress/dist/preview-info.txt

      - name: éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ
        run: |
          echo "è¿™é‡Œå¯ä»¥é…ç½®éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒçš„é€»è¾‘"
          echo "ä¾‹å¦‚ï¼šéƒ¨ç½²åˆ° Netlify, Vercel æˆ–å…¶ä»–å¹³å°"
          echo "æ„å»ºäº§ç‰©ä½ç½®: docs/.vitepress/dist"

      # å¯ä»¥æ·»åŠ å…·ä½“çš„é¢„è§ˆéƒ¨ç½²é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v2.0
      #   with:
      #     publish-dir: './docs/.vitepress/dist'
      #     production-branch: master
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"

  pr-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        run: pnpm build

      - name: PR é¢„è§ˆè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ é¢„è§ˆæ„å»ºå®Œæˆï¼\n\næ„å»ºçŠ¶æ€: âœ… æˆåŠŸ\nåˆ†æ”¯: `${{ github.head_ref }}`\næäº¤: `${{ github.sha }}`\n\nå¦‚éœ€è¦å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢„è§ˆé“¾æ¥ã€‚'
            })
